name: Trigger2
on:
  workflow_dispatch:

jobs:
  run-python:
    runs-on: windows-latest

    steps:
    # ==========================
    # 1. Checkout Repo A
    # ==========================
    - name: Checkout Repo A
      uses: actions/checkout@v4

    # ==========================
    # 2. Checkout Repo B into subfolder
    # ==========================
    - name: Checkout Repo B (output repo)
      uses: actions/checkout@v4
      with:
        #repository: ${{ secrets.REPO_B_USERNAME }}/${{ secrets.REPO_B_NAME }}
        repository: SJCoding0130/story
        token: ${{ secrets.OTHER_REPO_TOKEN }}
        path: repo_b
        fetch-depth: 1       # shallow clone
        sparse-checkout: |
          asset_metadata.json
          view.php

    # ==========================
    # 3. Set up Python
    # ==========================
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -U pip
        pip install requests
        pip install UnityPy

    # ==========================
    # 4. Run python script
    # ==========================
    - name: Run try.py and test.py
      shell: pwsh
      run: |
        cd repo_b
        python -u ../try.py
        python -u ../test.py

        echo "===== Files in repo_b ====="
        Get-ChildItem -Recurse -Force

        Start-Process -NoNewWindow -FilePath "php" -ArgumentList "-S localhost:8000"


        # Folder containing .book.json files
        $jsonFolder = ".\"

        # Endpoint URL
        $url = "http://localhost:8000/view.php"

        # Languages to generate
        $languages = @(
            "Text",
            "English",
            "ChineseTraditional",
            "ChineseSimplified"
        )

        # Find all .book.json files
        $jsonFiles = Get-ChildItem $jsonFolder -Filter "*.book.json"

        foreach ($file in $jsonFiles) {

            $baseName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)

            Write-Host "========================================"
            Write-Host "Processing file: $($file.Name)"
            Write-Host "========================================"

            foreach ($lang in $languages) {

        Write-Host "  → Language: $lang"

           # Map Text → Japanese (for filename only)
                $langLabel = if ($lang -eq "Text") { "Japanese" } else { $lang }

        $form = @{
            "language"   = $lang
            "playerName" = ""
            "jsonFile"   = $file
        }

        $response = Invoke-WebRequest `
            -Uri $url `
            -Method Post `
            -Form $form

        # Output filename
        $outputFile = ".\output\${baseName}_$lang.html"

        # Ensure output folder exists
        New-Item -ItemType Directory -Force -Path ".\output" | Out-Null

        $response.Content | Out-File $outputFile -Encoding UTF8

        Write-Host "    Saved: $outputFile"
            }
        }

        Write-Host "All files & languages processed!"



    # ==========================
    # 5. Push repo B updates
    # ==========================
    - name: Push updates to Repo B
      run: |
        cd repo_b
        git sparse-checkout disable
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git reset downloaded_assets/
        git commit -m "Update from Repo A workflow" || echo "No changes"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.OTHER_REPO_TOKEN }}
